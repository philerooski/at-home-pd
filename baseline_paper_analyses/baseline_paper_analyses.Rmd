---
title: "AT-HOME PD Smartphone Baseline Analyses"
output:
  html_document:
    df_print: paged
---

- All first burst, plot distributions wherever possible.
- Mean (SD) number of active tasks performed during first burst
  - break down by active task
- Compliance with first burst
- Which % of participants enrolled in passive data collection
  - Mean (SD) passive data records collected per day for those who enrolled
- Tapping interval, Turning time (gait) distribution
  - Ask megha about a single feature (energy?) that is demonstrative of tremor task variability across participants.
  - Within participants: use median of metric


```{r include=FALSE}
library(tidyverse)
library(synapser)
library(glue)

HEALTH_DATA_SUMMARY_TABLE <- "syn17015960"

synLogin()
```

```{r include=FALSE}
stat_mode <- function(x, return_multiple = TRUE, na.rm = FALSE) {
  if(na.rm){
    x <- na.omit(x)
  }
  ux <- unique(x)
  freq <- tabulate(match(x, ux))
  mode_loc <- if(return_multiple) which(freq==max(freq)) else which.max(freq)
  return(ux[mode_loc])
}

mutate_participant_day <- function(health_data_summary_table) {
  first_activity <- health_data_summary_table %>% 
    group_by(healthCode) %>%
    summarize(first_activity = lubridate::as_date(min(createdOnLocalTime, na.rm = T)))
  health_data_summary_table <- left_join(health_data_summary_table, first_activity)
  health_data_summary_table <- health_data_summary_table %>%
    mutate(createdOnLocalDate = lubridate::as_date(createdOnLocalTime),
           dayInStudy = as.integer(createdOnLocalDate - first_activity) + 1) %>% 
    select(-first_activity, -createdOnLocalDate)
  return(health_data_summary_table)
}

get_timezone_as_integer <- function(createdOnTimeZone) {
  # If there is no timezone information we make the conservative
  # (for a US user) estimate that the time zone is Pacific
  if (is.na(createdOnTimeZone)) {
    return(-8)
  } else {
    cotz_integer <- as.integer(as.integer(createdOnTimeZone) / 100)
    return(cotz_integer)
  }
}
```

```{r include=FALSE}
get_health_data_summary_table <- function() {
  health_data_summary_table <- as_tibble(
    synTableQuery(glue("SELECT * FROM { HEALTH_DATA_SUMMARY_TABLE }"))$asDataFrame())
  # Add local time and participant day 
  most_frequent_timezone <- health_data_summary_table %>% 
    filter(originalTable == "StudyBurst-v1") %>% 
    group_by(healthCode) %>%
    summarize(mostFrequentTimeZone = stat_mode(
      createdOnTimeZone, return_multiple = FALSE, na.rm = TRUE))
  health_data_summary_table <- left_join(
    health_data_summary_table, most_frequent_timezone) %>% 
    mutate(mostFrequentTimeZone = replace_na(mostFrequentTimeZone, "-800")) # assume PDT
  health_data_summary_table$createdOnTimeZoneInteger <- unlist(
    purrr::map(health_data_summary_table$mostFrequentTimeZone, get_timezone_as_integer))
  health_data_summary_table <- health_data_summary_table %>%  
    mutate(createdOnLocalTime = createdOn + lubridate::hours(createdOnTimeZoneInteger))
  health_data_summary_table <- mutate_participant_day(health_data_summary_table)
  return(health_data_summary_table)
}

health_data_summary_table <- get_health_data_summary_table()
```

```{r echo=FALSE}
#' Plot distributions showing number of active tasks completed 
#' during the first study burst period. Provide mean and SD for each active task
average_number_of_active_tasks_first_burst <- function(health_data_summary_table) {
  # TODO add back in users who did zero active tasks
  active_task_tables <- c("Tapping-v4", "WalkAndBalance-v1", "Tremor-v3") 
  active_tasks <- health_data_summary_table %>% 
    filter(originalTable %in% active_task_tables,
           dayInStudy < 19) %>% 
    mutate(task = case_when(
      originalTable == "Tremor-v3" ~ "Tremor",
      originalTable == "Tapping-v4" ~ "Tapping",
      originalTable == "WalkAndBalance-v1" ~ "Walk and Balance"))
  mean_sd_active_tasks <- active_tasks %>% 
    group_by(healthCode, task) %>% 
    summarize(num_tasks = n()) %>% 
    group_by(task) %>% 
    summarize(mean_tasks_per_participant = mean(num_tasks),
              sd_tasks_per_participant = sqrt(var(num_tasks)),
              text = paste0(
                round(mean_tasks_per_participant, 1),
                "±",
                round(sd_tasks_per_participant, 1)))
  burst_plot <- active_tasks %>% 
    group_by(healthCode, task) %>% 
    summarize(num_tasks = n()) %>% 
    ungroup() %>%
    count(task, num_tasks) %>% 
    left_join(mean_sd_active_tasks) %>% 
    mutate(`Task (Mean±SD)`= paste0(task, " (", text, ")")) %>% 
    ggplot(aes(num_tasks, n)) +
    #geom_density(aes(color = `Task (Mean±SD)`)) +
    #geom_bar(aes(fill = Task)) +
    geom_line(aes(color = `Task (Mean±SD)`),
              size = 1.5, lineend="round", alpha = 0.85) +
    #geom_point(aes(color = `Task (Mean±SD)`, shape = `Task (Mean±SD)`)) +
    theme_minimal() +
    theme(legend.position = c(0.8, 0.8),
          legend.background = element_rect(fill = "white", color = "black"),
          legend.key.height = unit(1, "cm"),
          text = element_text(size = 18)) +
    labs(x = "Active Tasks Completed", y = "Participant Count",
         title = "Active Tasks Completed During First Burst Window")
  return(burst_plot)
}

average_number_of_active_tasks_first_burst(health_data_summary_table)
```

```{r echo=FALSE}
#' Plot compliance by showing distribution of number of study bursts completed
#' As well as mean and standard deviation for number of study bursts completed
average_number_of_bursts_completed_first_burst <- function(health_data_summary_table) {
  num_study_burst <- health_data_summary_table %>% 
    filter(dayInStudy < 19) %>% 
    distinct(healthCode, originalTable, dayInStudy) %>% # only one burst a day should be possible
    group_by(healthCode) %>% 
    summarize(num_bursts = sum(originalTable == "StudyBurst-v1"))
  mean_sd_study_burst <- paste0(
    round(mean(num_study_burst$num_bursts), 1),
    "±",
    round(sqrt(var(num_study_burst$num_bursts))))
  study_burst_plot <- num_study_burst %>% 
    ggplot(aes(num_bursts)) +
    geom_bar(width = 0.5, color = "black", fill = "lightgray") +
    theme_minimal() +
    theme(text = element_text(size = 18)) +
    labs(x = "Burst Activities Completed", y = "Participant Count",
         title = "Study Burst Activities Completed During First Burst Window") +
    annotate("label", label.padding = unit(0.5, "lines"), x = 16, y = 24,
             label = paste0("Mean±SD = ", mean_sd_study_burst),
             size = 6)
  return(study_burst_plot)
}

average_number_of_bursts_completed_first_burst(health_data_summary_table)
```

```{r echo=FALSE}
# Look at number of days _any_ passive data was contributed??
# x axis: daysSinceConsent
# y axis: average number of records contributed per individual per day
passive_data_collection <- function(health_data_summary_table) {
  # ignore PassiveDisplacement-v4
  passive_tables <- c("PassiveGait-v1")
  passive_data <- health_data_summary_table %>%
    filter(originalTable %in% passive_tables)
  day_consented <- passive_data %>% 
    group_by(healthCode) %>% 
    summarize(dayConsented = lubridate::as_date(min(createdOnLocalTime)))
  passive_data <- inner_join(passive_data, day_consented) %>% 
    mutate(daysSinceConsent = lubridate::as_date(createdOnLocalTime) - dayConsented,
           daysSinceConsent = as.integer(daysSinceConsent)) %>% 
    group_by(healthCode, daysSinceConsent) %>% 
    summarize(numberOfPassiveActivities = n())
  min_max_days_since_consent <- passive_data %>% 
    group_by(healthCode) %>% 
    summarize(minDaysSinceConsent = 0,
           maxDaysSinceConsent = max(daysSinceConsent))
  all_possible_days_since_consent <- purrr::pmap_dfr(
    min_max_days_since_consent, function(healthCode, minDaysSinceConsent, maxDaysSinceConsent) {
      tibble(healthCode = healthCode, daysSinceConsent = minDaysSinceConsent:maxDaysSinceConsent)
    })
  passive_data <- full_join(passive_data, all_possible_days_since_consent) %>% 
    mutate(numberOfPassiveActivities = replace_na(numberOfPassiveActivities, 0)) %>% 
    arrange(healthCode, daysSinceConsent)
  mean_passive_records_per_day = mean(ungroup(passive_data)$numberOfPassiveActivities)
  passive_data <- passive_data %>% 
    group_by(daysSinceConsent) %>% 
    summarize(averageNumberOfPassiveActivities = mean(numberOfPassiveActivities))
  # Are we more interested in the distribution or the number of participants?
  # Mean (SD) is 5.84 (18.9). Does it even make sense to include them?
  # We can include mean as a vertical dotted line in the distribution
  # Median is 0
  passive_data %>% 
    ggplot(aes(daysSinceConsent, averageNumberOfPassiveActivities)) +
    geom_bar(fill = "hotpink3", alpha = 0.8, width = 1, stat = "identity") +
    geom_hline(aes(yintercept=mean_passive_records_per_day), linetype="dotted") +
    annotate("text", x = 170, y = mean_passive_records_per_day + 0.5,
             label = "Mean records per day") +
    theme_minimal() +
    labs(x = "Days Since Consent", y = "Passive Records",
         title = "Average Number of Passive Records Contributed per Day")
}

passive_data_collection(health_data_summary_table)
```

```{r echo=FALSE}
read_synapse_csv <- function(synapse_id) {
  f <- synGet(synapse_id)
  return(read_csv(f$path))
}

# Compate to clinical MDS-UPDRS measures
# Gait: compare gait_rotation with UPDRSAMR (Remote Ambulatory Capacity)
# Tapping: compare to C_NP3FTAPL (left hand) and C_NP3FTAPR (right hand)
# Tremor: compare to C_
plot_feature_distributions <- function(health_data_summary_table) {
  gait_features <- read_synapse_csv("syn21988725")  
  tapping_features <- read_synapse_csv("syn21995780")  
  tremor_features <- read_synapse_csv("syn22014562")
  mds <- read_synapse_csv("syn22005540")
  handedness <- read_synapse_csv("syn21670521") %>% 
    group_by(guid) %>% 
    summarize(HandsWriting = stat_mode(HandsWriting, return_multiple = F, na.rm=T)) %>% 
    mutate(HandsWriting = as.character(HandsWriting)) %>% 
    filter(HandsWriting %in% c("1", "2", "4", "5")) %>% # (Always, Usually) x (Right, Left)
    mutate(
      DominantHand = case_when(
        HandsWriting %in% c("1", "2") ~ "right",
        HandsWriting %in% c("4", "5") ~ "left")) %>% 
    select(guid, DominantHand)
  # Add guid to all feature files
  guids <- health_data_summary_table %>% 
    distinct(healthCode, externalId)
  gait_features <- inner_join(gait_features, guids) %>% 
    rename(guid = externalId)
  tapping_features <- inner_join(tapping_features, guids) %>% 
    rename(guid = externalId)
  tremor_features <- inner_join(tremor_features, guids) %>% 
    rename(guid = externalId)
  # add  relevant UPDRS scores to each feature file
  gait_features <- gait_features %>% 
    inner_join(select(mds, guid, UPDRSAMR)) %>% 
    drop_na() %>% 
    mutate(UPDRSAMR = as.character(UPDRSAMR))
  tapping_features <- tapping_features %>% 
    inner_join(handedness, by = "guid") %>% 
    mutate(handedness = case_when(
      hand == DominantHand ~ "Dominant",
      hand != DominantHand ~ "Non-dominant")) %>% 
    drop_na()
    #inner_join(select(mds, guid, C_NP3FTAPL, C_NP3FTAPR)) %>% 
    #drop_na() %>% 
    #mutate(C_NP3FTAPL = as.character(C_NP3FTAPL),
    #       C_NP3FTAPR = as.character(C_NP3FTAPR),
    #       C_NP3FTAP = case_when(
    #         hand == "left" ~ C_NP3FTAPL,
    #         hand == "right" ~ C_NP3FTAPR)) %>% 
    #select(-C_NP3FTAPL, -C_NP3FTAPR) # We don't want to accidentally use these
  tremor_features <- tremor_features %>% 
    inner_join(handedness, by = "guid") %>% 
    mutate(handedness = case_when(
      hand == DominantHand ~ "Dominant",
      hand != DominantHand ~ "Non-dominant"))
    #inner_join(select(mds, guid, C_NP3PTRMR, C_NP3PTRML)) %>% 
    #inner_join(select(mds, guid, MAX_RTTR))
    #mutate(C_NP3PTRMR = as.character(C_NP3PTRMR),
    #       C_NP3PTRML= as.character(C_NP3PTRML),
    #       C_NP3PTRM = case_when(
    #         hand == "left" ~ C_NP3PTRML,
    #         hand == "right" ~ C_NP3PTRMR)) %>% 
    #select(-C_NP3PTRML, -C_NP3PTRMR) # We don't want to accidentally use these
  # Plot controls from mPower 1 and age match with data from ahpd
  gait_features %>% 
    ggplot(aes(UPDRSAMR, rotation_omega)) +
    geom_boxplot(fill = RColorBrewer::brewer.pal(6, "Reds"), color = "black") +
    theme_minimal() +
    labs(x = "Remote Ambulatory Capacity", y = "Rotation Speed (rad/s)",
         title = "Turning Speed and Ambulatory Capacity")
  # Look at dominant-minor hand feature distributions
  # Plot controls from mPower 1 and age match with data from ahpd (tapping as well)
  tapping_features %>% 
    filter(medianTapInter < 1) %>% # not a realistic data point
    rename(Hand = handedness) %>% 
    ggplot(aes(medianTapInter)) +
    geom_density(aes(color = Hand)) +
    scale_x_continuous(trans = "log") +
    theme_minimal() +
    labs(x = "Average Intertap Interval", y = "Density",
         title = "Tremor Energy Dominant vs Non-Dominant Hand")
    #ggplot(aes(C_NP3FTAP, medianTapInter)) +
    #geom_boxplot(fill = RColorBrewer::brewer.pal(4, "Oranges"), color = "black") +
    labs(x = "3.4 Finger Tapping", y = "medianInterTap",
         title = "medianInterTap and 3.4 Finger Tapping")
  ### Re-run feature agg for energy tomorrow (mean -> median)
  tremor_features %>% 
    rename(Hand = handedness) %>% 
    ggplot(aes(energy.tm)) +
    geom_density(aes(color = Hand)) +
    scale_x_continuous(trans = "log") +
    theme_minimal() +
    labs(x = "Average Energy", y = "Density",
         title = "Tremor Energy Dominant vs Non-Dominant Hand")
}
```