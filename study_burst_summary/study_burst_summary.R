#' This script produces a table with columns:
#' 
#' * guid (str)
#' * guid_prefix (str)
#' * study_burst (str)
#' * study_burst_start_date (str)
#' * study_burst_end_date (str)
#' * days_completed (int)
#' * study_burst_successful (bool)
#' 
#' And stores this result to TABLE_OUTPUT (global var below).
#' 
#' This is more granular than the table produced by compliance_overview.R,
#' which summarizes study burst compliance at the study burst level (Y1,Q1, etc.)
library(synapser)
library(tidyverse)

HEALTH_DATA_SUMMARY_TABLE <- "syn17015960"
DAY_ONE_FILE <- "syn22345021"
TABLE_OUTPUT <- "syn20930854"

read_syn_table <- function(syn_id) {
  q <- synTableQuery(paste("select * from", syn_id))
  table <- q$asDataFrame() %>% 
    as_tibble() 
  return(table)
}

get_timezone_as_integer <- function(createdOnTimeZone) {
  # If there is no timezone information we make the conservative
  # (for a US user) estimate that the time zone is Pacific
  if (is.na(createdOnTimeZone)) {
    return(-8)
  } else {
    cotz_integer <- as.integer(as.integer(createdOnTimeZone) / 100)
    return(cotz_integer)
  }
}

fetch_mpower <- function() {
  mpower <- read_syn_table(HEALTH_DATA_SUMMARY_TABLE)
  mpower$createdOnTimeZoneInteger <- unlist(purrr::map(mpower$createdOnTimeZone,
                                                       get_timezone_as_integer))
  mpower <- mpower %>% 
    mutate(createdOnLocalTime = createdOn + lubridate::hours(createdOnTimeZoneInteger)) %>% 
    rename(guid = externalId)
  return(mpower)
}

build_study_burst_summary <- function(mpower) {
  #' We make the conservative (for a US user) assumption that the current day is
  #' relative to Pacific time.
  day_one_dates <- read_csv(synGet(DAY_ONE_FILE)$path) %>% 
    rename(activity_guid = externalId)
  first_activity <- day_one_dates %>% 
    mutate(currentDayInStudy = as.integer(
                lubridate::today(tz="America/Los_Angeles") - day_one_local_date),
              currentlyInStudyBurst = currentDayInStudy %% 90 < 20)
  study_burst_dates <- purrr::pmap_dfr(first_activity,
    function(activity_guid, day_one_local_date, currentDayInStudy, currentlyInStudyBurst) {
    dates <- purrr::map_dfr(0:7, function(i) {
      tibble(dates_guid = activity_guid,
             study_burst_number = i,
             study_burst_start_date = day_one_local_date + i * lubridate::days(90),
             study_burst_end_date = study_burst_start_date + lubridate::days(19),
             currentDayInStudy = currentDayInStudy,
             currentlyInStudyBurst = currentlyInStudyBurst)
    })                                      
    return(dates)
  })
  # TODO: check that the back-filled dayInStudy values look correct
  mpower_complete <- mpower %>% 
    left_join(first_activity, by = c("guid" = "activity_guid")) %>% 
    mutate(dayInStudy = ifelse(
      is.na(dayInStudy), as.integer(
      lubridate::as_date(createdOnLocalTime) - day_one_local_date) + 1,
      dayInStudy))
  days_completed <- purrr::pmap_dfr(study_burst_dates,
    function(dates_guid, study_burst_number, study_burst_start_date,
             study_burst_end_date, currentDayInStudy, currentlyInStudyBurst) {
      relevant_records <- mpower %>%
        filter(guid == dates_guid,
               createdOnLocalTime >= study_burst_start_date,
               createdOnLocalTime <= study_burst_end_date,
               originalTable == "StudyBurst-v1") %>% 
        distinct(dayInStudy)
      
      if(nrow(relevant_records) == 0 && lubridate::today() < study_burst_end_date) {
        days_completed <- NA
      } else {
        days_completed <- nrow(relevant_records)
      }
      days_completed_df <- tibble(
        guid = dates_guid,
        study_burst_number = study_burst_number,
        study_burst_start_date = study_burst_start_date,
        study_burst_end_date = study_burst_end_date,
        days_completed = days_completed)
     return(days_completed_df)
  })
      
      days_completed <- purrr::pmap_dfr(relevant_study_burst_dates,
        function(dates_guid, study_burst_number, study_burst_start_date, study_burst_end_date) {
          relevant_mpower <- mpower %>%
            filter(originalTable == "StudyBurst-v1",
                   guid == dates_guid,
                   createdOnLocalTime >= study_burst_start_date,
                   createdOnLocalTime <= study_burst_end_date)
          days_completed_this_burst <- n_distinct(relevant_mpower$dayInStudy)
          # If the participant has not yet finished this study burst, store NA for days completed
          if (days_completed_this_burst == 0 && study_burst_end_date >= lubridate::today()) {
            days_completed_this_burst = NA
          }
          tibble(days_guid = dates_guid,
                 study_burst_number = study_burst_number,
                 days_completed = days_completed_this_burst,
                 study_burst_successful = days_completed >= 10)
      })
  study_burst_summary <- mpower %>% 
    distinct(guid) %>% 
    left_join(study_burst_dates, by = c("guid" = "dates_guid")) %>% 
    left_join(days_completed, by = c("guid" = "days_guid", "study_burst_number")) %>% 
    rename(study_burst = study_burst_number) %>% 
    mutate(study_burst = as.character(study_burst),
           study_burst_start_date = as.character(study_burst_start_date),
           study_burst_end_date = as.character(study_burst_end_date),
           guid_prefix = str_extract(guid, "^.{3}")) %>% 
    arrange(guid, study_burst) %>% 
    select(guid, guid_prefix, study_burst, study_burst_start_date,
           study_burst_end_date, days_completed, study_burst_successful)
  study_burst_summary$study_burst <- dplyr::recode(
    study_burst_summary$study_burst, "0" = "Y1,Q1", "1" = "Y1,Q2", "2" = "Y1,Q3",
    "3" = "Y1,Q4", "4" = "Y2,Q1", "5" = "Y2,Q2", "6" = "Y2,Q3",
    "7" = "Y2,Q4")
  return(study_burst_summary)
}

store_to_synapse <- function(study_burst_summary) {
  q <- synTableQuery(paste("select * from", TABLE_OUTPUT))
  synDelete(q) # Remove preexisting rows
  t <- synTable(TABLE_OUTPUT, study_burst_summary)  
  synStore(t)
}

main <- function() {
  synLogin(Sys.getenv("synapseUsername"), Sys.getenv("synapsePassword"))
  mpower <- fetch_mpower()
  study_burst_summary <- build_study_burst_summary(mpower)
  store_to_synapse(study_burst_summary)
}

#main()
